In total 1 of 2 tests failed.


---
Outcome of test 'source_r': ok
All R files could be sourced.



---
Outcome of test 'do1': not ok


Details:

cmd_df = do_parse(do_code)
cmd_df = mark_data_manip_cmd(cmd_df)

str(cmd_df)
'data.frame':	38 obs. of  14 variables:
 $ line                        : int  1 2 3 4 5 6 7 8 9 10 ...
 $ do_code                     : chr  "use \"data.dta\", clear" "sort group i" "keep in 1/39" "list in 1/5" ...
 $ stata_cmd_original          : chr  "use" "sort" "keep" "list" ...
 $ stata_cmd                   : chr  "use" "sort" "keep" "list" ...
 $ rest_of_cmd                 : chr  "\"data.dta\", clear" "group i" "in 1/39" "in 1/5" ...
 $ is_by_prefix                : logi  FALSE FALSE FALSE FALSE FALSE TRUE ...
 $ by_group_vars               : chr  "" "" "" "" ...
 $ by_sort_vars                : chr  "" "" "" "" ...
 $ is_quietly_prefix           : logi  FALSE FALSE FALSE FALSE FALSE FALSE ...
 $ stata_translation_error     : chr  NA NA NA NA ...
 $ e_results_needed            :List of 38
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..- attr(*, "class")= chr "AsIs"
 $ r_results_needed            :List of 38
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..$ : chr 
  ..- attr(*, "class")= chr "AsIs"
 $ do_translate                : logi  TRUE TRUE TRUE FALSE FALSE TRUE ...
 $ will_have_original_order_idx: logi  TRUE TRUE TRUE TRUE TRUE TRUE ...
NULL

---
#Translate Stata to R commands... ... translation done.
---
# Run translated R commands and compare results


 1 do:  use "data.dta", clear
 1 r:  data = haven::read_dta(file.path(stata2r_env$working_dir, "data.dta")) %>% 
  sfun_strip_stata_attributes() %>% 
  sfun_normalize_string_nas() %>%
  dplyr::mutate(stata2r_original_order_idx = dplyr::row_number()) %>% 
  { assign("has_original_order_idx", TRUE, envir = stata2r_env); . } # 'clear' was used 
data = haven::read_dta(file.path(stata2r_env$working_dir, "data.dta")) %>% 
  sfun_strip_stata_attributes() %>% 
  sfun_normalize_string_nas() %>%
  dplyr::mutate(stata2r_original_order_idx = dplyr::row_number()) %>% 
  { assign("has_original_order_idx", TRUE, envir = stata2r_env); . } # 'clear' was used

 2 do:  sort group i
 2 r:  data = dplyr::arrange(data, !!!dplyr::syms(c("group", "i", "stata2r_original_order_idx"))) 
data = dplyr::arrange(data, !!!dplyr::syms(c("group", "i", "stata2r_original_order_idx")))

 3 do:  keep in 1/39
 3 r:  data = dplyr::slice(data, 1:39) 
data = dplyr::slice(data, 1:39)

 4 do:  list in 1/5 

 4 r:  not translated since not flagged as data manipulation

 5 do:  display _n 

 5 r:  not translated since not flagged as data manipulation

 6 do:  by group: gen seq = _n
 6 r:  data = data %>% 
  dplyr::group_by(!!!dplyr::syms(c("group"))) %>% 
  dplyr::mutate(`seq` = as.numeric(dplyr::row_number())) %>% 
  dplyr::ungroup() 
data = data %>% 
  dplyr::group_by(!!!dplyr::syms(c("group"))) %>% 
  dplyr::mutate(`seq` = as.numeric(dplyr::row_number())) %>% 
  dplyr::ungroup()

 7 do:  gen logi = log(i)
 7 r:  data = data %>% 
  dplyr::mutate(`logi` = as.numeric(log(`i`))) 
data = data %>% 
  dplyr::mutate(`logi` = as.numeric(log(`i`)))

Error: After Stata line  7 , R data set differs from Stata reference.

Data set from Stata (do_df):
tibble [39 × 4] (S3: tbl_df/tbl/data.frame)
 $ i    : num [1:39] 10 13 16 19 20 21 22 27 31 34 ...
  ..- attr(*, "label")= chr "i"
  ..- attr(*, "format.stata")= chr "%9.0g"
 $ group: chr [1:39] "A" "A" "A" "A" ...
  ..- attr(*, "label")= chr "group"
  ..- attr(*, "format.stata")= chr "%1s"
 $ seq  : num [1:39] 1 2 3 4 5 6 7 8 9 10 ...
  ..- attr(*, "format.stata")= chr "%9.0g"
 $ logi : num [1:39] 2.3 2.56 2.77 2.94 3 ...
  ..- attr(*, "format.stata")= chr "%9.0g"
 - attr(*, "label")= chr "Written by R."
NULL

Data set from R (r_df):
tibble [39 × 5] (S3: tbl_df/tbl/data.frame)
 $ i                         : num [1:39] 10 13 16 19 20 21 22 27 31 34 ...
 $ group                     : chr [1:39] "A" "A" "A" "A" ...
 $ stata2r_original_order_idx: int [1:39] 10 13 16 19 20 21 22 27 31 34 ...
 $ seq                       : num [1:39] 1 2 3 4 5 6 7 8 9 10 ...
 $ logi                      : num [1:39] 2.3 2.56 2.77 2.94 3 ...
NULL

Differences:List of 2
 $ identical     : logi FALSE
 $ value_mismatch:'data.frame':	5 obs. of  4 variables:
  ..$ row      : int [1:5] 1 2 3 4 5
  ..$ column   : chr [1:5] "logi" "logi" "logi" "logi" ...
  ..$ df1_value: chr [1:5] "2.302585125" "2.5649492741" "2.7725887299" "2.9444389343" ...
  ..$ df2_value: chr [1:5] "2.302585093" "2.5649493575" "2.7725887222" "2.9444389792" ...
NULL
