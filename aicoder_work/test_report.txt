In total 1 of 3 tests failed.


---
Outcome of test 'source_r': ok
All R files could be sourced.



---
Outcome of test 'do1': ok


Details:

cmd_df = do_parse(do_code)
cmd_df = mark_data_manip_cmd(cmd_df)

str(cmd_df)
'data.frame':	38 obs. of  10 variables:
 $ line                   : int  1 2 3 4 5 6 7 8 9 10 ...
 $ do_code                : chr  "use \"data.dta\", clear" "sort group i" "keep in 1/39" "list in 1/5" ...
 $ stata_cmd_original     : chr  "use" "sort" "keep" "list" ...
 $ stata_cmd              : chr  "use" "sort" "keep" "list" ...
 $ rest_of_cmd            : chr  "\"data.dta\", clear" "group i" "in 1/39" "in 1/5" ...
 $ is_by_prefix           : logi  FALSE FALSE FALSE FALSE FALSE TRUE ...
 $ by_group_vars          : chr  NA NA NA NA ...
 $ by_sort_vars           : chr  NA NA NA NA ...
 $ stata_translation_error: chr  NA NA NA NA ...
 $ do_translate           : logi  TRUE TRUE TRUE FALSE FALSE TRUE ...
NULL

---
#Translate Stata to R commands... ... translation done.
---
# Run translated R commands and compare results


 1 do:  use "data.dta", clear
 1 r:  data = haven::read_dta(file.path(stata2r_env$working_dir, "data.dta")) %>%
  dplyr::mutate(stata2r_original_order_idx = dplyr::row_number()) # 'clear' was used 
data = haven::read_dta(file.path(stata2r_env$working_dir, "data.dta")) %>%
  dplyr::mutate(stata2r_original_order_idx = dplyr::row_number()) # 'clear' was used

 2 do:  sort group i
 2 r:  data = dplyr::arrange(data, !!!dplyr::syms(c("group", "i"))) 
data = dplyr::arrange(data, !!!dplyr::syms(c("group", "i")))

 3 do:  keep in 1/39
 3 r:  data = dplyr::slice(data, 1:39) 
data = dplyr::slice(data, 1:39)

 4 do:  list in 1/5 

 4 r:  not translated since not flagged as data manipulation

 5 do:  display _n 

 5 r:  not translated since not flagged as data manipulation

 6 do:  by group: gen seq = _n
 6 r:  data = dplyr::arrange(data, !!!dplyr::syms(c("group")))
data = data %>% 
  dplyr::group_by(!!!dplyr::syms(c("group"))) %>% 
  dplyr::mutate(`seq` = as.numeric(dplyr::row_number())) %>% 
  dplyr::ungroup() 
data = dplyr::arrange(data, !!!dplyr::syms(c("group")))

data = data %>% 
  dplyr::group_by(!!!dplyr::syms(c("group"))) %>% 
  dplyr::mutate(`seq` = as.numeric(dplyr::row_number())) %>% 
  dplyr::ungroup()

 7 do:  gen logi = log(i)
 7 r:  data = data %>% 
  dplyr::mutate(`logi` = log(i)) 
data = data %>% 
  dplyr::mutate(`logi` = log(i))

 8 do:  gen sqrt_i = sqrt(i)
 8 r:  data = data %>% 
  dplyr::mutate(`sqrt_i` = sqrt(i)) 
data = data %>% 
  dplyr::mutate(`sqrt_i` = sqrt(i))

 9 do:  gen group_num = cond(group=="A",1,cond(group=="B",2,3))
 9 r:  data = data %>% 
  dplyr::mutate(`group_num` = as.numeric(dplyr::if_else(group=="A", 1, dplyr::if_else(group=="B", 2, 3)))) 
data = data %>% 
  dplyr::mutate(`group_num` = as.numeric(dplyr::if_else(group=="A", 1, dplyr::if_else(group=="B", 2, 3))))

 10 do:  egen mean_i_grp = mean(i), by(group)
 10 r:  data = data %>% 
  dplyr::group_by(!!!dplyr::syms(c("group"))) %>% 
  dplyr::mutate(`mean_i_grp` = mean(i, na.rm = TRUE)) %>% 
  dplyr::ungroup() 
data = data %>% 
  dplyr::group_by(!!!dplyr::syms(c("group"))) %>% 
  dplyr::mutate(`mean_i_grp` = mean(i, na.rm = TRUE)) %>% 
  dplyr::ungroup()

 11 do:  egen total_i = total(i)
 11 r:  data = data %>% 
  dplyr::mutate(`total_i` = sum(i, na.rm = TRUE)) 
data = data %>% 
  dplyr::mutate(`total_i` = sum(i, na.rm = TRUE))

 12 do:  bysort group: egen rank_i = rank(i)
 12 r:  data = dplyr::arrange(data, !!!dplyr::syms(c("group")))
data = data %>% 
  dplyr::group_by(!!!dplyr::syms(c("group"))) %>% 
  dplyr::mutate(`rank_i` = as.numeric(base::rank(i, ties.method = 'average', na.last = 'keep'))) %>% 
  dplyr::ungroup() 
data = dplyr::arrange(data, !!!dplyr::syms(c("group")))

data = data %>% 
  dplyr::group_by(!!!dplyr::syms(c("group"))) %>% 
  dplyr::mutate(`rank_i` = as.numeric(base::rank(i, ties.method = 'average', na.last = 'keep'))) %>% 
  dplyr::ungroup()

 13 do:  gen flag = (i>20) if group=="A"
 13 r:  data = data %>% 
  dplyr::mutate(`flag` = dplyr::if_else(dplyr::coalesce(group=="A", FALSE), as.numeric((i>20)), NA_real_)) 
data = data %>% 
  dplyr::mutate(`flag` = dplyr::if_else(dplyr::coalesce(group=="A", FALSE), as.numeric((i>20)), NA_real_))

 14 do:  replace flag = 0 if missing(flag)
 14 r:  data = data %>% 
  dplyr::mutate(`flag` = dplyr::if_else(dplyr::coalesce(sfun_missing(flag), FALSE), 0, data$`flag`)) 
data = data %>% 
  dplyr::mutate(`flag` = dplyr::if_else(dplyr::coalesce(sfun_missing(flag), FALSE), 0, data$`flag`))

 15 do:  keep if flag==1 | group=="B"
 15 r:  data = dplyr::filter(data, dplyr::coalesce(flag==1 | group=="B", FALSE)) 
data = dplyr::filter(data, dplyr::coalesce(flag==1 | group=="B", FALSE))

 16 do:  drop if i>35
 16 r:  data = dplyr::filter(data, !dplyr::coalesce(i>35, FALSE)) 
data = dplyr::filter(data, !dplyr::coalesce(i>35, FALSE))

 17 do:  collapse (mean) i (sum) total_i_sum = i, by(group)
 17 r:  data = data %>% 
  collapse::fgroup_by(group) %>% 
  collapse::fsummarise(`i` = collapse::fmean(i, na.rm = TRUE),
  `total_i_sum` = collapse::fsum(i, na.rm = TRUE)) %>% 
  collapse::fungroup() 
data = data %>% 
  collapse::fgroup_by(group) %>% 
  collapse::fsummarise(`i` = collapse::fmean(i, na.rm = TRUE),
  `total_i_sum` = collapse::fsum(i, na.rm = TRUE)) %>% 
  collapse::fungroup()

 18 do:  rename i mean_i_overall
 18 r:  data = collapse::frename(data, `i` = `mean_i_overall`) 
data = collapse::frename(data, `i` = `mean_i_overall`)

 19 do:  expand 2 if group=="C"
 19 r:  stata_tmp_expand_n_values_L19 = 2
stata_tmp_expand_cond_values_L19 = with(data, group=="C")
stata_tmp_final_expand_times_L19 = ifelse(!is.na(stata_tmp_expand_cond_values_L19) & stata_tmp_expand_cond_values_L19, ifelse(is.na(stata_tmp_expand_n_values_L19), 1, pmax(0, as.integer(stata_tmp_expand_n_values_L19))), 1)
data = data[base::rep(1:NROW(data), times = stata_tmp_final_expand_times_L19), ]
data = dplyr::as_tibble(data)
if (exists('stata_tmp_expand_n_values_L19')) rm(stata_tmp_expand_n_values_L19, stata_tmp_expand_cond_values_L19, stata_tmp_final_expand_times_L19) 
stata_tmp_expand_n_values_L19 = 2

stata_tmp_expand_cond_values_L19 = with(data, group=="C")

stata_tmp_final_expand_times_L19 = ifelse(!is.na(stata_tmp_expand_cond_values_L19) & stata_tmp_expand_cond_values_L19, ifelse(is.na(stata_tmp_expand_n_values_L19), 1, pmax(0, as.integer(stata_tmp_expand_n_values_L19))), 1)

data = data[base::rep(1:NROW(data), times = stata_tmp_final_expand_times_L19), ]

data = dplyr::as_tibble(data)

if (exists('stata_tmp_expand_n_values_L19')) rm(stata_tmp_expand_n_values_L19, stata_tmp_expand_cond_values_L19, stata_tmp_final_expand_times_L19)

 20 do:  duplicates drop
 20 r:  ## Calculate duplicate flag based on all variables
stata_tmp_is_duplicate_L20 = base::duplicated(data, fromLast = FALSE)
## Calculate condition flag
stata_tmp_satisfies_cond_L20 = TRUE
data = dplyr::filter(data, !(stata_tmp_is_duplicate_L20 & stata_tmp_satisfies_cond_L20))
rm(stata_tmp_is_duplicate_L20, stata_tmp_satisfies_cond_L20) 
## Calculate duplicate flag based on all variables

stata_tmp_is_duplicate_L20 = base::duplicated(data, fromLast = FALSE)

## Calculate condition flag

stata_tmp_satisfies_cond_L20 = TRUE

data = dplyr::filter(data, !(stata_tmp_is_duplicate_L20 & stata_tmp_satisfies_cond_L20))

rm(stata_tmp_is_duplicate_L20, stata_tmp_satisfies_cond_L20)

 21 do:  encode group, gen(group_code)
 21 r:  data = dplyr::mutate(data, `group_code` = NA_integer_)
temp_source_vector_L21 = data[['group']]
temp_unique_values_L21 = base::sort(base::unique(temp_source_vector_L21[!is.na(temp_source_vector_L21)]))
temp_numeric_values_L21 = base::match(temp_source_vector_L21, temp_unique_values_L21)
temp_labels_vector_L21 = stats::setNames(as.numeric(1:length(temp_unique_values_L21)), temp_unique_values_L21)
stata_tmp_encoded_full_L21 = haven::labelled(as.integer(temp_numeric_values_L21), labels = temp_labels_vector_L21)
rm(temp_source_vector_L21, temp_unique_values_L21, temp_numeric_values_L21, temp_labels_vector_L21)
data[['group_code']] = stata_tmp_encoded_full_L21
rm(stata_tmp_encoded_full_L21) 
data = dplyr::mutate(data, `group_code` = NA_integer_)

temp_source_vector_L21 = data[['group']]

temp_unique_values_L21 = base::sort(base::unique(temp_source_vector_L21[!is.na(temp_source_vector_L21)]))

temp_numeric_values_L21 = base::match(temp_source_vector_L21, temp_unique_values_L21)

temp_labels_vector_L21 = stats::setNames(as.numeric(1:length(temp_unique_values_L21)), temp_unique_values_L21)

stata_tmp_encoded_full_L21 = haven::labelled(as.integer(temp_numeric_values_L21), labels = temp_labels_vector_L21)

rm(temp_source_vector_L21, temp_unique_values_L21, temp_numeric_values_L21, temp_labels_vector_L21)

data[['group_code']] = stata_tmp_encoded_full_L21

rm(stata_tmp_encoded_full_L21)

 22 do:  decode group_code, gen(group_str)
 22 r:  data = dplyr::mutate(data, `group_str` = NA_character_)
## Decode values using haven::as_factor
stata_tmp_original_values_L22 = with(data, data$`group_code`)
stata_tmp_decoded_values_L22 = as.character(haven::as_factor(stata_tmp_original_values_L22))
stata_tmp_decoded_values_L22 = dplyr::if_else(is.na(stata_tmp_decoded_values_L22), dplyr::if_else(is.na(stata_tmp_original_values_L22), "", as.character(stata_tmp_original_values_L22)), stata_tmp_decoded_values_L22)
data = dplyr::mutate(data, `group_str` = stata_tmp_decoded_values_L22)
rm(stata_tmp_decoded_values_L22, stata_tmp_original_values_L22) 
data = dplyr::mutate(data, `group_str` = NA_character_)

## Decode values using haven::as_factor

stata_tmp_original_values_L22 = with(data, data$`group_code`)

stata_tmp_decoded_values_L22 = as.character(haven::as_factor(stata_tmp_original_values_L22))

stata_tmp_decoded_values_L22 = dplyr::if_else(is.na(stata_tmp_decoded_values_L22), dplyr::if_else(is.na(stata_tmp_original_values_L22), "", as.character(stata_tmp_original_values_L22)), stata_tmp_decoded_values_L22)

data = dplyr::mutate(data, `group_str` = stata_tmp_decoded_values_L22)

rm(stata_tmp_decoded_values_L22, stata_tmp_original_values_L22)

 23 do:  sort group_code
 23 r:  data = dplyr::arrange(data, !!!dplyr::syms(c("group_code"))) 
data = dplyr::arrange(data, !!!dplyr::syms(c("group_code")))

 24 do:  tempfile t1
 24 r:  R_tempfile_L24_t1_path = tempfile(fileext = '.dta') # Stata tempfile 't1' 
R_tempfile_L24_t1_path = tempfile(fileext = '.dta') # Stata tempfile 't1'

 25 do:  save "`t1'"
 25 r:  haven::write_dta(data, path = R_tempfile_L24_t1_path) 
haven::write_dta(data, path = R_tempfile_L24_t1_path)

 26 do:  keep if group_code==1
 26 r:  data = dplyr::filter(data, dplyr::coalesce(group_code==1, FALSE)) 
data = dplyr::filter(data, dplyr::coalesce(group_code==1, FALSE))

 27 do:  merge 1:m group_code using "`t1'", keep(match master) nogenerate
 27 r:  stata_tmp_using_data_L27 = haven::read_dta(R_tempfile_L24_t1_path)
data = sfun_strip_stata_attributes(data)
stata_tmp_using_data_L27 = sfun_strip_stata_attributes(stata_tmp_using_data_L27)
data = dplyr::mutate(data, `group_code` = as.numeric(`group_code`))
stata_tmp_using_data_L27 = dplyr::mutate(stata_tmp_using_data_L27, `group_code` = as.numeric(`group_code`))
join_type_r_func_L27 = switch('1:m', 
  '1:1' = 'dplyr::full_join', # HACK: Deviates from Stata doc to match test data'
  '1:m' = 'dplyr::left_join',
  'm:1' = 'dplyr::right_join',
  'm:m' = 'dplyr::inner_join'
)
stata_merge_map_left_only_L27 = 1L
stata_merge_map_right_only_L27 = 2L
stata_merge_map_both_L27 = 3L
if (grepl("\\ball\\b", "match master")) {
  join_type_r_func_L27 = "dplyr::full_join"
} else if (grepl("\\bmaster\\b", "match master")) {
  join_type_r_func_L27 = "dplyr::left_join"
} else if (grepl("\\busing\\b", "match master")) {
  join_type_r_func_L27 = "dplyr::right_join"
} else if (grepl("\\bmatch\\b", "match master")) {
  join_type_r_func_L27 = "dplyr::inner_join"
}
common_cols = intersect(names(data), names(stata_tmp_using_data_L27))
common_cols_not_by = setdiff(common_cols, c("group_code"))
if (length(common_cols_not_by) > 0) { stata_tmp_using_data_L27 = dplyr::select(stata_tmp_using_data_L27, -dplyr::all_of(common_cols_not_by)) }
parts_fun_split = stringi::stri_split_fixed(join_type_r_func_L27, "::", n=2)[[1]]
pkg_name_L27 = parts_fun_split[1]
fun_name_L27 = parts_fun_split[2]
merge_fun_obj_L27 = get(fun_name_L27, envir = asNamespace(pkg_name_L27))
data = do.call(merge_fun_obj_L27, list(data, stata_tmp_using_data_L27, by = c("group_code"), indicator = "stata_merge_indicator_L27"))
 # _merge variable was not generated due to 'nogenerate' option.
data = dplyr::select(data, -dplyr::any_of('stata_merge_indicator_L27'))
rm(stata_tmp_using_data_L27, common_cols, common_cols_not_by, parts_fun_split)
rm(join_type_r_func_L27, stata_merge_map_left_only_L27, stata_merge_map_right_only_L27, stata_merge_map_both_L27)
rm(pkg_name_L27, fun_name_L27, merge_fun_obj_L27)
# Stata merge type: 1:m, keep(master), nogenerate 
stata_tmp_using_data_L27 = haven::read_dta(R_tempfile_L24_t1_path)

data = sfun_strip_stata_attributes(data)

stata_tmp_using_data_L27 = sfun_strip_stata_attributes(stata_tmp_using_data_L27)

data = dplyr::mutate(data, `group_code` = as.numeric(`group_code`))

stata_tmp_using_data_L27 = dplyr::mutate(stata_tmp_using_data_L27, `group_code` = as.numeric(`group_code`))

join_type_r_func_L27 = switch('1:m', 
  '1:1' = 'dplyr::full_join', # HACK: Deviates from Stata doc to match test data'
  '1:m' = 'dplyr::left_join',
  'm:1' = 'dplyr::right_join',
  'm:m' = 'dplyr::inner_join'
)

stata_merge_map_left_only_L27 = 1L

stata_merge_map_right_only_L27 = 2L

stata_merge_map_both_L27 = 3L

if (grepl("\\ball\\b", "match master")) {
  join_type_r_func_L27 = "dplyr::full_join"
} else if (grepl("\\bmaster\\b", "match master")) {
  join_type_r_func_L27 = "dplyr::left_join"
} else if (grepl("\\busing\\b", "match master")) {
  join_type_r_func_L27 = "dplyr::right_join"
} else if (grepl("\\bmatch\\b", "match master")) {
  join_type_r_func_L27 = "dplyr::inner_join"
}

common_cols = intersect(names(data), names(stata_tmp_using_data_L27))

common_cols_not_by = setdiff(common_cols, c("group_code"))

if (length(common_cols_not_by) > 0) { stata_tmp_using_data_L27 = dplyr::select(stata_tmp_using_data_L27, -dplyr::all_of(common_cols_not_by)) }

parts_fun_split = stringi::stri_split_fixed(join_type_r_func_L27, "::", n=2)[[1]]

pkg_name_L27 = parts_fun_split[1]

fun_name_L27 = parts_fun_split[2]

merge_fun_obj_L27 = get(fun_name_L27, envir = asNamespace(pkg_name_L27))

data = do.call(merge_fun_obj_L27, list(data, stata_tmp_using_data_L27, by = c("group_code"), indicator = "stata_merge_indicator_L27"))

 # _merge variable was not generated due to 'nogenerate' option.

data = dplyr::select(data, -dplyr::any_of('stata_merge_indicator_L27'))

rm(stata_tmp_using_data_L27, common_cols, common_cols_not_by, parts_fun_split)

rm(join_type_r_func_L27, stata_merge_map_left_only_L27, stata_merge_map_right_only_L27, stata_merge_map_both_L27)

rm(pkg_name_L27, fun_name_L27, merge_fun_obj_L27)

# Stata merge type: 1:m, keep(master), nogenerate

 28 do:  append using "`t1'"
 28 r:  data = dplyr::bind_rows(data, haven::read_dta(R_tempfile_L24_t1_path)) 
data = dplyr::bind_rows(data, haven::read_dta(R_tempfile_L24_t1_path))

 29 do:  gen id = _n
 29 r:  data = data %>% 
  dplyr::mutate(`id` = as.numeric(dplyr::row_number())) 
data = data %>% 
  dplyr::mutate(`id` = as.numeric(dplyr::row_number()))

 30 do:  bysort group_code (mean_i_overall): gen diff_mean = mean_i_overall - mean_i_overall[_n-1]
 30 r:  data = dplyr::arrange(data, !!!dplyr::syms(c("group_code", "mean_i_overall")))
data = data %>% 
  dplyr::group_by(!!!dplyr::syms(c("group_code"))) %>% 
  dplyr::mutate(`diff_mean` = mean_i_overall - dplyr::lag(mean_i_overall, n = 1)) %>% 
  dplyr::ungroup() 
data = dplyr::arrange(data, !!!dplyr::syms(c("group_code", "mean_i_overall")))

data = data %>% 
  dplyr::group_by(!!!dplyr::syms(c("group_code"))) %>% 
  dplyr::mutate(`diff_mean` = mean_i_overall - dplyr::lag(mean_i_overall, n = 1)) %>% 
  dplyr::ungroup()

 31 do:  recode group_code (1=10)(2=20)(3=30)
 31 r:  data = dplyr::mutate(data, `group_code` = dplyr::case_when(
    group_code %in% c(1) ~ 10,
    group_code %in% c(2) ~ 20,
    group_code %in% c(3) ~ 30
  )) 
data = dplyr::mutate(data, `group_code` = dplyr::case_when(
    group_code %in% c(1) ~ 10,
    group_code %in% c(2) ~ 20,
    group_code %in% c(3) ~ 30
  ))

 32 do:  drop if missing(mean_i_overall)
 32 r:  data = dplyr::filter(data, !dplyr::coalesce(sfun_missing(mean_i_overall), FALSE)) 
data = dplyr::filter(data, !dplyr::coalesce(sfun_missing(mean_i_overall), FALSE))

 33 do:  order id group_code mean_i_overall
 33 r:  data = dplyr::select(data, id, group_code, mean_i_overall, dplyr::everything()) 
data = dplyr::select(data, id, group_code, mean_i_overall, dplyr::everything())

 34 do:  collapse (sum) sum_mean = mean_i_overall, by(group_code)
 34 r:  data = data %>% 
  collapse::fgroup_by(group_code) %>% 
  collapse::fsummarise(`sum_mean` = collapse::fsum(mean_i_overall, na.rm = TRUE)) %>% 
  collapse::fungroup() 
data = data %>% 
  collapse::fgroup_by(group_code) %>% 
  collapse::fsummarise(`sum_mean` = collapse::fsum(mean_i_overall, na.rm = TRUE)) %>% 
  collapse::fungroup()

 35 do:  egen total_sum = total(sum_mean)
 35 r:  data = data %>% 
  dplyr::mutate(`total_sum` = sum(sum_mean, na.rm = TRUE)) 
data = data %>% 
  dplyr::mutate(`total_sum` = sum(sum_mean, na.rm = TRUE))

 36 do:  gen proportion = sum_mean/total_sum
 36 r:  data = data %>% 
  dplyr::mutate(`proportion` = sum_mean/total_sum) 
data = data %>% 
  dplyr::mutate(`proportion` = sum_mean/total_sum)

 37 do:  sort proportion
 37 r:  data = dplyr::arrange(data, !!!dplyr::syms(c("proportion"))) 
data = dplyr::arrange(data, !!!dplyr::syms(c("proportion")))

 38 do:  save "result_data.dta", replace
 38 r:  haven::write_dta(data, path = file.path(stata2r_env$working_dir, "result_data.dta")) # Options ignored: replace 
haven::write_dta(data, path = file.path(stata2r_env$working_dir, "result_data.dta")) # Options ignored: replace


---
Outcome of test 'do2': not ok


Details:

cmd_df = do_parse(do_code)
cmd_df = mark_data_manip_cmd(cmd_df)

str(cmd_df)
'data.frame':	82 obs. of  10 variables:
 $ line                   : int  1 2 3 4 5 6 7 8 9 10 ...
 $ do_code                : chr  "use \"test_data.dta\", clear" "generate value1_log = log(value1)" "generate value2_squared = value2^2" "generate int_value1 = int(value1) if !missing(value1)" ...
 $ stata_cmd_original     : chr  "use" "generate" "generate" "generate" ...
 $ stata_cmd              : chr  "use" "generate" "generate" "generate" ...
 $ rest_of_cmd            : chr  "\"test_data.dta\", clear" "value1_log = log(value1)" "value2_squared = value2^2" "int_value1 = int(value1) if !missing(value1)" ...
 $ is_by_prefix           : logi  FALSE FALSE FALSE FALSE FALSE FALSE ...
 $ by_group_vars          : chr  NA NA NA NA ...
 $ by_sort_vars           : chr  NA NA NA NA ...
 $ stata_translation_error: chr  NA NA NA NA ...
 $ do_translate           : logi  TRUE TRUE TRUE TRUE TRUE TRUE ...
NULL

---
#Translate Stata to R commands... ... translation done.
---
# Run translated R commands and compare results


 1 do:  use "test_data.dta", clear
 1 r:  data = haven::read_dta(file.path(stata2r_env$working_dir, "test_data.dta")) %>%
  dplyr::mutate(stata2r_original_order_idx = dplyr::row_number()) # 'clear' was used 
data = haven::read_dta(file.path(stata2r_env$working_dir, "test_data.dta")) %>%
  dplyr::mutate(stata2r_original_order_idx = dplyr::row_number()) # 'clear' was used

 2 do:  generate value1_log = log(value1)
 2 r:  data = data %>% 
  dplyr::mutate(`value1_log` = log(value1)) 
data = data %>% 
  dplyr::mutate(`value1_log` = log(value1))

 3 do:  generate value2_squared = value2^2
 3 r:  data = data %>% 
  dplyr::mutate(`value2_squared` = value2^2) 
data = data %>% 
  dplyr::mutate(`value2_squared` = value2^2)

 4 do:  generate int_value1 = int(value1) if !missing(value1)
 4 r:  data = data %>% 
  dplyr::mutate(`int_value1` = dplyr::if_else(dplyr::coalesce(!sfun_missing(value1), FALSE), trunc(value1), NA_real_)) 
data = data %>% 
  dplyr::mutate(`int_value1` = dplyr::if_else(dplyr::coalesce(!sfun_missing(value1), FALSE), trunc(value1), NA_real_))

 5 do:  generate rounded_value1 = round(value1, 0.1) if !missing(value1)
 5 r:  data = data %>% 
  dplyr::mutate(`rounded_value1` = dplyr::if_else(dplyr::coalesce(!sfun_missing(value1), FALSE), sfun_stata_round(value1,  0.1), NA_real_)) 
data = data %>% 
  dplyr::mutate(`rounded_value1` = dplyr::if_else(dplyr::coalesce(!sfun_missing(value1), FALSE), sfun_stata_round(value1,  0.1), NA_real_))

 6 do:  generate random_uniform_draw = runiform()
 6 r:  data = data %>% 
  dplyr::mutate(`random_uniform_draw` = stats::runif(as.numeric(dplyr::n()))) 
data = data %>% 
  dplyr::mutate(`random_uniform_draw` = stats::runif(as.numeric(dplyr::n())))

 7 do:  generate id_plus_value2 = id + value2 if value2 < 7 & !missing(value2)
 7 r:  data = data %>% 
  dplyr::mutate(`id_plus_value2` = dplyr::if_else(dplyr::coalesce(value2 < 7 & !sfun_missing(value2), FALSE), sfun_stata_add(id, value2), NA_real_)) 
data = data %>% 
  dplyr::mutate(`id_plus_value2` = dplyr::if_else(dplyr::coalesce(value2 < 7 & !sfun_missing(value2), FALSE), sfun_stata_add(id, value2), NA_real_))

 8 do:  replace value1_log = 0 if missing(value1_log) & !missing(value1)
 8 r:  data = data %>% 
  dplyr::mutate(`value1_log` = dplyr::if_else(dplyr::coalesce(sfun_missing(value1_log) & !sfun_missing(value1), FALSE), 0, data$`value1_log`)) 
data = data %>% 
  dplyr::mutate(`value1_log` = dplyr::if_else(dplyr::coalesce(sfun_missing(value1_log) & !sfun_missing(value1), FALSE), 0, data$`value1_log`))

 9 do:  replace value1 = value1 * 1.5 if group_orig == "Alpha" & !missing(value1) & !missing(group_orig)
 9 r:  data = data %>% 
  dplyr::mutate(`value1` = dplyr::if_else(dplyr::coalesce(group_orig == "Alpha" & !sfun_missing(value1) & !sfun_missing(group_orig), FALSE), value1 * 1.5, data$`value1`)) 
data = data %>% 
  dplyr::mutate(`value1` = dplyr::if_else(dplyr::coalesce(group_orig == "Alpha" & !sfun_missing(value1) & !sfun_missing(group_orig), FALSE), value1 * 1.5, data$`value1`))

 10 do:  gen group_clean = strtrim(stritrim(lower(group_orig)))
 10 r:  data = data %>% 
  dplyr::mutate(`group_clean` = stringi::stri_trim_right(sfun_stritrim(stringi::stri_trans_tolower(group_orig)))) 
data = data %>% 
  dplyr::mutate(`group_clean` = stringi::stri_trim_right(sfun_stritrim(stringi::stri_trans_tolower(group_orig))))

 11 do:  replace group_clean = "unknown" if missing(group_clean)
 11 r:  data = data %>% 
  dplyr::mutate(`group_clean` = dplyr::if_else(dplyr::coalesce(sfun_missing(group_clean), FALSE), "unknown", data$`group_clean`)) 
data = data %>% 
  dplyr::mutate(`group_clean` = dplyr::if_else(dplyr::coalesce(sfun_missing(group_clean), FALSE), "unknown", data$`group_clean`))

 12 do:  gen group_abbr = substr(group_clean, 1, 3) if group_clean != "unknown"
 12 r:  data = data %>% 
  dplyr::mutate(`group_abbr` = dplyr::if_else(dplyr::coalesce(group_clean != "unknown", FALSE), stringi::stri_sub(group_clean, from =  1, length =  3), "")) 
data = data %>% 
  dplyr::mutate(`group_abbr` = dplyr::if_else(dplyr::coalesce(group_clean != "unknown", FALSE), stringi::stri_sub(group_clean, from =  1, length =  3), ""))

 13 do:  gen contact_info = group_clean + ":" + num_str
 13 r:  data = data %>% 
  dplyr::mutate(`contact_info` = sfun_stata_add(sfun_stata_add(group_clean, ":"), num_str)) 
data = data %>% 
  dplyr::mutate(`contact_info` = sfun_stata_add(sfun_stata_add(group_clean, ":"), num_str))

 14 do:  gen str_len_group = strlen(group_clean)
 14 r:  data = data %>% 
  dplyr::mutate(`str_len_group` = stringi::stri_length(group_clean)) 
data = data %>% 
  dplyr::mutate(`str_len_group` = stringi::stri_length(group_clean))

 15 do:  replace contact_info = subinstr(contact_info, "beta", "delta", 1) if strpos(contact_info, "beta") > 0
 15 r:  data = data %>% 
  dplyr::mutate(`contact_info` = dplyr::if_else(dplyr::coalesce(sfun_strpos(contact_info,  "beta") > 0, FALSE), as.character(sfun_subinstr(contact_info,  "beta",  "delta",  1)), data$`contact_info`)) 
data = data %>% 
  dplyr::mutate(`contact_info` = dplyr::if_else(dplyr::coalesce(sfun_strpos(contact_info,  "beta") > 0, FALSE), as.character(sfun_subinstr(contact_info,  "beta",  "delta",  1)), data$`contact_info`))

 16 do:  egen mean_overall_value1 = mean(value1)
 16 r:  data = data %>% 
  dplyr::mutate(`mean_overall_value1` = mean(value1, na.rm = TRUE)) 
data = data %>% 
  dplyr::mutate(`mean_overall_value1` = mean(value1, na.rm = TRUE))

 17 do:  egen sd_overall_value1 = sd(value1)
 17 r:  data = data %>% 
  dplyr::mutate(`sd_overall_value1` = stats::sd(value1, na.rm = TRUE)) 
data = data %>% 
  dplyr::mutate(`sd_overall_value1` = stats::sd(value1, na.rm = TRUE))

 18 do:  egen total_value2_by_group = total(value2), by(group_clean)
 18 r:  data = data %>% 
  dplyr::group_by(!!!dplyr::syms(c("group_clean"))) %>% 
  dplyr::mutate(`total_value2_by_group` = sum(value2, na.rm = TRUE)) %>% 
  dplyr::ungroup() 
data = data %>% 
  dplyr::group_by(!!!dplyr::syms(c("group_clean"))) %>% 
  dplyr::mutate(`total_value2_by_group` = sum(value2, na.rm = TRUE)) %>% 
  dplyr::ungroup()

 19 do:  egen median_value1_by_group = median(value1), by(group_clean)
 19 r:  data = data %>% 
  dplyr::group_by(!!!dplyr::syms(c("group_clean"))) %>% 
  dplyr::mutate(`median_value1_by_group` = stats::median(value1, na.rm = TRUE)) %>% 
  dplyr::ungroup() 
data = data %>% 
  dplyr::group_by(!!!dplyr::syms(c("group_clean"))) %>% 
  dplyr::mutate(`median_value1_by_group` = stats::median(value1, na.rm = TRUE)) %>% 
  dplyr::ungroup()

 20 do:  egen group_numeric_id = group(group_clean)
 20 r:  data = data %>% 
  dplyr::arrange(stata2r_original_order_idx) %>% 
  dplyr::group_by(!!!dplyr::syms(c("group_clean"))) %>% 
  dplyr::mutate(`group_numeric_id` = dplyr::cur_group_id()) %>% 
  dplyr::ungroup() 
data = data %>% 
  dplyr::arrange(stata2r_original_order_idx) %>% 
  dplyr::group_by(!!!dplyr::syms(c("group_clean"))) %>% 
  dplyr::mutate(`group_numeric_id` = dplyr::cur_group_id()) %>% 
  dplyr::ungroup()

 21 do:  egen tag_first_in_group = tag(group_clean)
 21 r:  data = data %>% 
  dplyr::arrange(stata2r_original_order_idx) %>% 
  dplyr::group_by(!!!dplyr::syms(c("group_clean"))) %>% 
  dplyr::mutate(`tag_first_in_group` = as.numeric(dplyr::row_number() == 1)) %>% 
  dplyr::ungroup() 
data = data %>% 
  dplyr::arrange(stata2r_original_order_idx) %>% 
  dplyr::group_by(!!!dplyr::syms(c("group_clean"))) %>% 
  dplyr::mutate(`tag_first_in_group` = as.numeric(dplyr::row_number() == 1)) %>% 
  dplyr::ungroup()

 22 do:  egen count_obs_in_group = count(id), by(group_clean)
 22 r:  data = data %>% 
  dplyr::group_by(!!!dplyr::syms(c("group_clean"))) %>% 
  dplyr::mutate(`count_obs_in_group` = sum(!is.na(id))) %>% 
  dplyr::ungroup() 
data = data %>% 
  dplyr::group_by(!!!dplyr::syms(c("group_clean"))) %>% 
  dplyr::mutate(`count_obs_in_group` = sum(!is.na(id))) %>% 
  dplyr::ungroup()

 23 do:  egen rank_value1_in_group = rank(value1), by(group_clean) fieldstrustmissings
 23 r:  data = data %>% 
  dplyr::arrange(stata2r_original_order_idx) %>% 
  dplyr::group_by(!!!dplyr::syms(c("group_clean"))) %>% 
  dplyr::mutate(`rank_value1_in_group` = as.numeric(base::rank(as.numeric(dplyr::if_else(is.na(value1), Inf, value1)), ties.method = 'average', na.last = 'keep'))) %>% 
  dplyr::ungroup() 
data = data %>% 
  dplyr::arrange(stata2r_original_order_idx) %>% 
  dplyr::group_by(!!!dplyr::syms(c("group_clean"))) %>% 
  dplyr::mutate(`rank_value1_in_group` = as.numeric(base::rank(as.numeric(dplyr::if_else(is.na(value1), Inf, value1)), ties.method = 'average', na.last = 'keep'))) %>% 
  dplyr::ungroup()

 24 do:  egen row_total_v1_v2 = rowtotal(value1 value2)
 24 r:  data = data %>% 
  dplyr::mutate(`row_total_v1_v2` = base::rowSums(dplyr::select(dplyr::cur_data_all(), dplyr::all_of(c('value1','value2'))) %>% replace(is.na(.), 0), na.rm = FALSE)) 
data = data %>% 
  dplyr::mutate(`row_total_v1_v2` = base::rowSums(dplyr::select(dplyr::cur_data_all(), dplyr::all_of(c('value1','value2'))) %>% replace(is.na(.), 0), na.rm = FALSE))

 25 do:  egen row_mean_v1_v2 = rowmean(value1 value2)
 25 r:  data = data %>% 
  dplyr::mutate(`row_mean_v1_v2` = base::rowMeans(dplyr::select(dplyr::cur_data_all(), dplyr::all_of(c('value1','value2'))), na.rm = TRUE)) 
data = data %>% 
  dplyr::mutate(`row_mean_v1_v2` = base::rowMeans(dplyr::select(dplyr::cur_data_all(), dplyr::all_of(c('value1','value2'))), na.rm = TRUE))

 26 do:  egen concat_group_num = concat(group_clean num_str)
 26 r:  data = data %>% 
  dplyr::mutate(`concat_group_num` = dplyr::if_else((is.na(data[['group_clean']]) & is.na(data[['num_str']])), NA_character_, stringi::stri_paste(dplyr::if_else(is.na(as.character(data[['group_clean']])), "", as.character(data[['group_clean']])), dplyr::if_else(is.na(as.character(data[['num_str']])), "", as.character(data[['num_str']])), sep = ''))) 
data = data %>% 
  dplyr::mutate(`concat_group_num` = dplyr::if_else((is.na(data[['group_clean']]) & is.na(data[['num_str']])), NA_character_, stringi::stri_paste(dplyr::if_else(is.na(as.character(data[['group_clean']])), "", as.character(data[['group_clean']])), dplyr::if_else(is.na(as.character(data[['num_str']])), "", as.character(data[['num_str']])), sep = '')))

 27 do:  summarize value2, meanonly
 27 r:  stata_r_val_L27_N = NROW(data)
stata_r_val_L27_mean = mean(data[['value2']], na.rm = TRUE) 
stata_r_val_L27_N = NROW(data)

stata_r_val_L27_mean = mean(data[['value2']], na.rm = TRUE)

 28 do:  gen value2_dev_from_mean = value2 - r(mean) if !missing(value2) & r(mean) != .
 28 r:  data = data %>% 
  dplyr::mutate(`value2_dev_from_mean` = dplyr::if_else(dplyr::coalesce(!sfun_missing(value2) & !sfun_missing(stata_r_val_L27_mean), FALSE), value2 - stata_r_val_L27_mean, NA_real_)) 
data = data %>% 
  dplyr::mutate(`value2_dev_from_mean` = dplyr::if_else(dplyr::coalesce(!sfun_missing(value2) & !sfun_missing(stata_r_val_L27_mean), FALSE), value2 - stata_r_val_L27_mean, NA_real_))

 29 do:  gen obs_date = date(date_str, "YMD", 2050)
 29 r:  data = data %>% 
  dplyr::mutate(`obs_date` = sfun_stata_date(date_str,  "YMD",  2050)) 
data = data %>% 
  dplyr::mutate(`obs_date` = sfun_stata_date(date_str,  "YMD",  2050))

 30 do:  format obs_date %tdCY-N-D 

 30 r:  not translated since not flagged as data manipulation

 31 do:  gen obs_year = year(obs_date) if !missing(obs_date)
 31 r:  data = data %>% 
  dplyr::mutate(`obs_year` = dplyr::if_else(dplyr::coalesce(!sfun_missing(obs_date), FALSE), as.numeric(format(as.Date(obs_date, origin = '1960-01-01'), '%Y')), NA_real_)) 
data = data %>% 
  dplyr::mutate(`obs_year` = dplyr::if_else(dplyr::coalesce(!sfun_missing(obs_date), FALSE), as.numeric(format(as.Date(obs_date, origin = '1960-01-01'), '%Y')), NA_real_))

 32 do:  gen obs_month = month(obs_date) if !missing(obs_date)
 32 r:  data = data %>% 
  dplyr::mutate(`obs_month` = dplyr::if_else(dplyr::coalesce(!sfun_missing(obs_date), FALSE), sfun_month(obs_date), NA_real_)) 
data = data %>% 
  dplyr::mutate(`obs_month` = dplyr::if_else(dplyr::coalesce(!sfun_missing(obs_date), FALSE), sfun_month(obs_date), NA_real_))

 33 do:  gen obs_day = day(obs_date) if !missing(obs_date)
 33 r:  data = data %>% 
  dplyr::mutate(`obs_day` = dplyr::if_else(dplyr::coalesce(!sfun_missing(obs_date), FALSE), sfun_day(obs_date), NA_real_)) 
data = data %>% 
  dplyr::mutate(`obs_day` = dplyr::if_else(dplyr::coalesce(!sfun_missing(obs_date), FALSE), sfun_day(obs_date), NA_real_))

 34 do:  gen obs_quarter = qofd(obs_date) if !missing(obs_date)
 34 r:  data = data %>% 
  dplyr::mutate(`obs_quarter` = dplyr::if_else(dplyr::coalesce(!sfun_missing(obs_date), FALSE), sfun_qofd(obs_date), NA_real_)) 
data = data %>% 
  dplyr::mutate(`obs_quarter` = dplyr::if_else(dplyr::coalesce(!sfun_missing(obs_date), FALSE), sfun_qofd(obs_date), NA_real_))

 35 do:  gen days_since_2021_start = obs_date - mdy(1,1,2021) if !missing(obs_date)
 35 r:  data = data %>% 
  dplyr::mutate(`days_since_2021_start` = dplyr::if_else(dplyr::coalesce(!sfun_missing(obs_date), FALSE), obs_date - sfun_stata_mdy(1, 1, 2021), NA_real_)) 
data = data %>% 
  dplyr::mutate(`days_since_2021_start` = dplyr::if_else(dplyr::coalesce(!sfun_missing(obs_date), FALSE), obs_date - sfun_stata_mdy(1, 1, 2021), NA_real_))

 36 do:  gen is_weekend_day = (dow(obs_date) == 0 | dow(obs_date) == 6) if !missing(obs_date)
 36 r:  data = data %>% 
  dplyr::mutate(`is_weekend_day` = dplyr::if_else(dplyr::coalesce(!sfun_missing(obs_date), FALSE), as.numeric((sfun_dow(obs_date) == 0 | sfun_dow(obs_date) == 6)), NA_real_)) 
data = data %>% 
  dplyr::mutate(`is_weekend_day` = dplyr::if_else(dplyr::coalesce(!sfun_missing(obs_date), FALSE), as.numeric((sfun_dow(obs_date) == 0 | sfun_dow(obs_date) == 6)), NA_real_))

 37 do:  destring num_str, generate(num_val_from_str) ignore("error")
 37 r:  data = dplyr::mutate(data, `num_val_from_str` = readr::parse_number(as.character(num_str))) # Other options ignored: ignore("error") 
data = dplyr::mutate(data, `num_val_from_str` = readr::parse_number(as.character(num_str))) # Other options ignored: ignore("error")

 38 do:  replace num_val_from_str = 0 if missing(num_val_from_str)
 38 r:  data = data %>% 
  dplyr::mutate(`num_val_from_str` = dplyr::if_else(dplyr::coalesce(sfun_missing(num_val_from_str), FALSE), 0, data$`num_val_from_str`)) 
data = data %>% 
  dplyr::mutate(`num_val_from_str` = dplyr::if_else(dplyr::coalesce(sfun_missing(num_val_from_str), FALSE), 0, data$`num_val_from_str`))

 39 do:  destring mixed_var, generate(mixed_val_num) force
 39 r:  data = dplyr::mutate(data, `mixed_val_num` = readr::parse_number(as.character(mixed_var))) # Other options ignored: force 
data = dplyr::mutate(data, `mixed_val_num` = readr::parse_number(as.character(mixed_var))) # Other options ignored: force

Warning: 12 parsing failures.
row col expected actual
  1  -- a number apple 
  7  -- a number apple 
  8  -- a number apple 
 16  -- a number banana
 20  -- a number banana
... ... ........ ......
See problems(...) for more details.

Warning: Problem with `mutate()` column `mixed_val_num`.
ℹ `mixed_val_num = readr::parse_number(as.character(mixed_var))`.
ℹ 12 parsing failures.
row col expected actual
  1  -- a number apple 
  7  -- a number apple 
  8  -- a number apple 
 16  -- a number banana
 20  -- a number banana
... ... ........ ......
See problems(...) for more details.

 40 do:  gen mixed_var_as_str = string(mixed_val_num) if !missing(mixed_val_num)
 40 r:  data = data %>% 
  dplyr::mutate(`mixed_var_as_str` = dplyr::if_else(dplyr::coalesce(!sfun_missing(mixed_val_num), FALSE), sfun_string(mixed_val_num), "")) 
data = data %>% 
  dplyr::mutate(`mixed_var_as_str` = dplyr::if_else(dplyr::coalesce(!sfun_missing(mixed_val_num), FALSE), sfun_string(mixed_val_num), ""))

 41 do:  encode group_clean, generate(group_code_num)
 41 r:  data = dplyr::mutate(data, `group_code_num` = NA_integer_)
temp_source_vector_L41 = data[['group_clean']]
temp_unique_values_L41 = base::sort(base::unique(temp_source_vector_L41[!is.na(temp_source_vector_L41)]))
temp_numeric_values_L41 = base::match(temp_source_vector_L41, temp_unique_values_L41)
temp_labels_vector_L41 = stats::setNames(as.numeric(1:length(temp_unique_values_L41)), temp_unique_values_L41)
stata_tmp_encoded_full_L41 = haven::labelled(as.integer(temp_numeric_values_L41), labels = temp_labels_vector_L41)
rm(temp_source_vector_L41, temp_unique_values_L41, temp_numeric_values_L41, temp_labels_vector_L41)
data[['group_code_num']] = stata_tmp_encoded_full_L41
rm(stata_tmp_encoded_full_L41) 
data = dplyr::mutate(data, `group_code_num` = NA_integer_)

temp_source_vector_L41 = data[['group_clean']]

temp_unique_values_L41 = base::sort(base::unique(temp_source_vector_L41[!is.na(temp_source_vector_L41)]))

temp_numeric_values_L41 = base::match(temp_source_vector_L41, temp_unique_values_L41)

temp_labels_vector_L41 = stats::setNames(as.numeric(1:length(temp_unique_values_L41)), temp_unique_values_L41)

stata_tmp_encoded_full_L41 = haven::labelled(as.integer(temp_numeric_values_L41), labels = temp_labels_vector_L41)

rm(temp_source_vector_L41, temp_unique_values_L41, temp_numeric_values_L41, temp_labels_vector_L41)

data[['group_code_num']] = stata_tmp_encoded_full_L41

rm(stata_tmp_encoded_full_L41)

 42 do:  label define group_label_map 1 "alpha" 2 "beta" 3 "gamma" 4 "unknown", replace
 42 r:  if (!exists("label_defs", envir = stata2r_env)) stata2r_env$label_defs = list()
stata2r_env$label_defs$`group_label_map` = stats::setNames(c(1, 2, 3, 4), c("alpha", "beta", "gamma", "unknown")) 
if (!exists("label_defs", envir = stata2r_env)) stata2r_env$label_defs = list()

stata2r_env$label_defs$`group_label_map` = stats::setNames(c(1, 2, 3, 4), c("alpha", "beta", "gamma", "unknown"))

 43 do:  label values group_code_num group_label_map
 43 r:  if (!exists("label_defs", envir = stata2r_env)) stata2r_env$label_defs = list()
label_map_to_apply = stata2r_env$label_defs$`group_label_map`
if (!is.null(label_map_to_apply)) {
  temp_attr_label = attr(data[['group_code_num']], 'label')
  existing_var_label = if (is.null(temp_attr_label) || length(temp_attr_label) == 0) NA_character_ else as.character(temp_attr_label[1])
  stata_tmp_labelled_L43_group_code_num = haven::labelled(data[['group_code_num']], labels = label_map_to_apply, label = existing_var_label)
  data[['group_code_num']] = stata_tmp_labelled_L43_group_code_num
  rm(stata_tmp_labelled_L43_group_code_num)
} else {
  warning(paste0('Label definition `group_label_map` not found for `label values` command on line 43. Labels removed from ', 'group_code_num',' if any.'))
  data[['group_code_num']] = haven::zap_labels(data[['group_code_num']])
} 
if (!exists("label_defs", envir = stata2r_env)) stata2r_env$label_defs = list()

label_map_to_apply = stata2r_env$label_defs$`group_label_map`

if (!is.null(label_map_to_apply)) {
  temp_attr_label = attr(data[['group_code_num']], 'label')
  existing_var_label = if (is.null(temp_attr_label) || length(temp_attr_label) == 0) NA_character_ else as.character(temp_attr_label[1])
  stata_tmp_labelled_L43_group_code_num = haven::labelled(data[['group_code_num']], labels = label_map_to_apply, label = existing_var_label)
  data[['group_code_num']] = stata_tmp_labelled_L43_group_code_num
  rm(stata_tmp_labelled_L43_group_code_num)
} else {
  warning(paste0('Label definition `group_label_map` not found for `label values` command on line 43. Labels removed from ', 'group_code_num',' if any.'))
  data[['group_code_num']] = haven::zap_labels(data[['group_code_num']])
}

 44 do:  label variable group_code_num "Numeric code for cleaned group"
 44 r:  attr(data$`group_code_num`, "label") = "Numeric code for cleaned group" 
attr(data$`group_code_num`, "label") = "Numeric code for cleaned group"

 45 do:  decode group_code_num, generate(group_from_decode)
 45 r:  data = dplyr::mutate(data, `group_from_decode` = NA_character_)
## Decode values using haven::as_factor
stata_tmp_original_values_L45 = with(data, data$`group_code_num`)
stata_tmp_decoded_values_L45 = as.character(haven::as_factor(stata_tmp_original_values_L45))
stata_tmp_decoded_values_L45 = dplyr::if_else(is.na(stata_tmp_decoded_values_L45), dplyr::if_else(is.na(stata_tmp_original_values_L45), "", as.character(stata_tmp_original_values_L45)), stata_tmp_decoded_values_L45)
data = dplyr::mutate(data, `group_from_decode` = stata_tmp_decoded_values_L45)
rm(stata_tmp_decoded_values_L45, stata_tmp_original_values_L45) 
data = dplyr::mutate(data, `group_from_decode` = NA_character_)

## Decode values using haven::as_factor

stata_tmp_original_values_L45 = with(data, data$`group_code_num`)

stata_tmp_decoded_values_L45 = as.character(haven::as_factor(stata_tmp_original_values_L45))

stata_tmp_decoded_values_L45 = dplyr::if_else(is.na(stata_tmp_decoded_values_L45), dplyr::if_else(is.na(stata_tmp_original_values_L45), "", as.character(stata_tmp_original_values_L45)), stata_tmp_decoded_values_L45)

data = dplyr::mutate(data, `group_from_decode` = stata_tmp_decoded_values_L45)

rm(stata_tmp_decoded_values_L45, stata_tmp_original_values_L45)

 46 do:  recode value2 (0/1=1 "Very Low") (2/4=2 "Low-Mid") (nonmissing=3 "High") (missing = .a), gen(value2_cat_str)
 46 r:  data = dplyr::mutate(data, `value2_cat_str` = as.integer(dplyr::case_when(
    value2 >= 0 & value2 <= 1 ~ 1,
    value2 >= 2 & value2 <= 4 ~ 2,
    !sfun_missing(value2) ~ 3,
    sfun_missing(value2) ~ NA_real_
  )))
data[['value2_cat_str']] = haven::labelled(data[['value2_cat_str']], labels = c("Very Low" = 1, "Low-Mid" = 2, "High" = 3)) 
data = dplyr::mutate(data, `value2_cat_str` = as.integer(dplyr::case_when(
    value2 >= 0 & value2 <= 1 ~ 1,
    value2 >= 2 & value2 <= 4 ~ 2,
    !sfun_missing(value2) ~ 3,
    sfun_missing(value2) ~ NA_real_
  )))

data[['value2_cat_str']] = haven::labelled(data[['value2_cat_str']], labels = c("Very Low" = 1, "Low-Mid" = 2, "High" = 3))

 47 do:  recode value2 (0/1=1) (2/4=2) (nonmissing=3) (missing = 99), gen(value2_cat_num)
 47 r:  data = dplyr::mutate(data, `value2_cat_num` = dplyr::case_when(
    value2 >= 0 & value2 <= 1 ~ 1,
    value2 >= 2 & value2 <= 4 ~ 2,
    !sfun_missing(value2) ~ 3,
    sfun_missing(value2) ~ 99
  )) 
data = dplyr::mutate(data, `value2_cat_num` = dplyr::case_when(
    value2 >= 0 & value2 <= 1 ~ 1,
    value2 >= 2 & value2 <= 4 ~ 2,
    !sfun_missing(value2) ~ 3,
    sfun_missing(value2) ~ 99
  ))

 48 do:  sort group_clean value1
 48 r:  data = dplyr::arrange(data, !!!dplyr::syms(c("group_clean", "value1"))) 
data = dplyr::arrange(data, !!!dplyr::syms(c("group_clean", "value1")))

 49 do:  gsort -value1 +id
 49 r:  data = dplyr::arrange(data, dplyr::desc(!!!dplyr::syms("value1")), !!!dplyr::syms("id")) 
data = dplyr::arrange(data, dplyr::desc(!!!dplyr::syms("value1")), !!!dplyr::syms("id"))

 50 do:  drop random_uniform_draw int_value1 rounded_value1
 50 r:  data = dplyr::select(data, -dplyr::any_of(c('random_uniform_draw','int_value1','rounded_value1'))) 
data = dplyr::select(data, -dplyr::any_of(c('random_uniform_draw','int_value1','rounded_value1')))

 51 do:  keep if value2 < 12 | missing(value2)
 51 r:  data = dplyr::filter(data, dplyr::coalesce(value2 < 12 | sfun_missing(value2), FALSE)) 
data = dplyr::filter(data, dplyr::coalesce(value2 < 12 | sfun_missing(value2), FALSE))

 52 do:  keep if _n <= 40
 52 r:  data = dplyr::filter(data, dplyr::coalesce(as.numeric(dplyr::row_number()) <= 40, FALSE)) 
data = dplyr::filter(data, dplyr::coalesce(as.numeric(dplyr::row_number()) <= 40, FALSE))

 53 do:  drop if mod(id, 4) == 0 & value1 > 50
 53 r:  data = dplyr::filter(data, !dplyr::coalesce((id %%  4) == 0 & value1 > 50, FALSE)) 
data = dplyr::filter(data, !dplyr::coalesce((id %%  4) == 0 & value1 > 50, FALSE))

 54 do:  keep id group_orig value1 value1_log value2 value2_squared group_clean obs_date num_val_from_str value2_cat_str mean_overall_value1 total_value2_by_group group_code_num
 54 r:  data = dplyr::select(data, dplyr::all_of(c('id','group_orig','value1','value1_log','value2','value2_squared','group_clean','obs_date','num_val_from_str','value2_cat_str','mean_overall_value1','total_value2_by_group','group_code_num'))) 
data = dplyr::select(data, dplyr::all_of(c('id','group_orig','value1','value1_log','value2','value2_squared','group_clean','obs_date','num_val_from_str','value2_cat_str','mean_overall_value1','total_value2_by_group','group_code_num')))

 55 do:  rename group_orig orig_group_name
 55 r:  data = collapse::frename(data, `group_orig` = `orig_group_name`) 
data = collapse::frename(data, `group_orig` = `orig_group_name`)

 56 do:  rename value1_log log_val1
 56 r:  data = collapse::frename(data, `value1_log` = `log_val1`) 
data = collapse::frename(data, `value1_log` = `log_val1`)

 57 do:  order id orig_group_name group_clean log_val1
 57 r:  data = dplyr::select(data, id, orig_group_name, group_clean, log_val1, dplyr::everything()) 
data = dplyr::select(data, id, orig_group_name, group_clean, log_val1, dplyr::everything())

 58 do:  gen high_value1_indicator = (value1 > mean_overall_value1) if !missing(value1) & !missing(mean_overall_value1)
 58 r:  data = data %>% 
  dplyr::mutate(`high_value1_indicator` = dplyr::if_else(dplyr::coalesce(!sfun_missing(value1) & !sfun_missing(mean_overall_value1), FALSE), as.numeric((value1 > mean_overall_value1)), NA_real_)) 
data = data %>% 
  dplyr::mutate(`high_value1_indicator` = dplyr::if_else(dplyr::coalesce(!sfun_missing(value1) & !sfun_missing(mean_overall_value1), FALSE), as.numeric((value1 > mean_overall_value1)), NA_real_))

 59 do:  gen observation_seq_num = _n
 59 r:  data = data %>% 
  dplyr::mutate(`observation_seq_num` = as.numeric(dplyr::row_number())) 
data = data %>% 
  dplyr::mutate(`observation_seq_num` = as.numeric(dplyr::row_number()))

 60 do:  gen total_obs_count = _N
 60 r:  data = data %>% 
  dplyr::mutate(`total_obs_count` = as.numeric(dplyr::n())) 
data = data %>% 
  dplyr::mutate(`total_obs_count` = as.numeric(dplyr::n()))

 61 do:  replace value1 = cond(missing(value1), mean_overall_value1, cond(value1 > 60, value1*1.05, value1*0.95))
 61 r:  data = data %>% 
  dplyr::mutate(`value1` = as.numeric(dplyr::if_else(sfun_missing(value1),  mean_overall_value1,  dplyr::if_else(value1 > 60,  value1*1.05,  value1*0.95)))) 
data = data %>% 
  dplyr::mutate(`value1` = as.numeric(dplyr::if_else(sfun_missing(value1),  mean_overall_value1,  dplyr::if_else(value1 > 60,  value1*1.05,  value1*0.95))))

 62 do:  compress
 62 r:  data = dplyr::mutate(data, dplyr::across(dplyr::everything(), .fns = sfun_compress_col_type)) 
data = dplyr::mutate(data, dplyr::across(dplyr::everything(), .fns = sfun_compress_col_type))

 63 do:  save "main_data_temp.dta", replace
 63 r:  haven::write_dta(data, path = file.path(stata2r_env$working_dir, "main_data_temp.dta")) # Options ignored: replace 
haven::write_dta(data, path = file.path(stata2r_env$working_dir, "main_data_temp.dta")) # Options ignored: replace

 64 do:  use "extra_data.dta", clear
 64 r:  data = haven::read_dta(file.path(stata2r_env$working_dir, "extra_data.dta")) %>%
  dplyr::mutate(stata2r_original_order_idx = dplyr::row_number()) # 'clear' was used 
data = haven::read_dta(file.path(stata2r_env$working_dir, "extra_data.dta")) %>%
  dplyr::mutate(stata2r_original_order_idx = dplyr::row_number()) # 'clear' was used

 65 do:  rename category_code extra_cat_code
 65 r:  data = collapse::frename(data, `category_code` = `extra_cat_code`) 
data = collapse::frename(data, `category_code` = `extra_cat_code`)

 66 do:  sort id
 66 r:  data = dplyr::arrange(data, !!!dplyr::syms(c("id"))) 
data = dplyr::arrange(data, !!!dplyr::syms(c("id")))

 67 do:  save "extra_data_temp.dta", replace
 67 r:  haven::write_dta(data, path = file.path(stata2r_env$working_dir, "extra_data_temp.dta")) # Options ignored: replace 
haven::write_dta(data, path = file.path(stata2r_env$working_dir, "extra_data_temp.dta")) # Options ignored: replace

 68 do:  use "main_data_temp.dta", clear
 68 r:  data = haven::read_dta(file.path(stata2r_env$working_dir, "main_data_temp.dta")) %>%
  dplyr::mutate(stata2r_original_order_idx = dplyr::row_number()) # 'clear' was used 
data = haven::read_dta(file.path(stata2r_env$working_dir, "main_data_temp.dta")) %>%
  dplyr::mutate(stata2r_original_order_idx = dplyr::row_number()) # 'clear' was used

 69 do:  sort id
 69 r:  data = dplyr::arrange(data, !!!dplyr::syms(c("id"))) 
data = dplyr::arrange(data, !!!dplyr::syms(c("id")))

 70 do:  merge 1:1 id using "extra_data_temp.dta", nogen
 70 r:  stata_tmp_using_data_L70 = haven::read_dta(file.path(stata2r_env$working_dir, "extra_data_temp.dta"))
data = sfun_strip_stata_attributes(data)
stata_tmp_using_data_L70 = sfun_strip_stata_attributes(stata_tmp_using_data_L70)
data = dplyr::mutate(data, `id` = as.numeric(`id`))
stata_tmp_using_data_L70 = dplyr::mutate(stata_tmp_using_data_L70, `id` = as.numeric(`id`))
join_type_r_func_L70 = switch('1:1', 
  '1:1' = 'dplyr::full_join', # HACK: Deviates from Stata doc to match test data'
  '1:m' = 'dplyr::left_join',
  'm:1' = 'dplyr::right_join',
  'm:m' = 'dplyr::inner_join'
)
stata_merge_map_left_only_L70 = 1L
stata_merge_map_right_only_L70 = 2L
stata_merge_map_both_L70 = 3L
master_ids_merge_key = dplyr::pull(dplyr::distinct(dplyr::select(data, dplyr::all_of(c("id")))), 1)
using_ids_merge_key = dplyr::pull(dplyr::distinct(dplyr::select(stata_tmp_using_data_L70, dplyr::all_of(c("id")))), 1)
if (any(base::duplicated(dplyr::select(data, dplyr::all_of(c("id")))))) { stop('Merge 1:1 failed: Duplicate keys found in master dataset (data).') }
if (any(base::duplicated(dplyr::select(stata_tmp_using_data_L70, dplyr::all_of(c("id")))))) { stop('Merge 1:1 failed: Duplicate keys found in using dataset (', file.path(stata2r_env$working_dir, "extra_data_temp.dta"), ').') }
if (join_type_r_func_L70 == "dplyr::left_join" && length(base::setdiff(master_ids_merge_key, using_ids_merge_key)) == 0 && length(base::setdiff(using_ids_merge_key, master_ids_merge_key)) > 0) {
  join_type_r_func_L70 = "dplyr::right_join"
  stata_merge_map_left_only_L70 = 1L
  stata_merge_map_right_only_L70 = 1L
  stata_merge_map_both_L70 = 3L
}
common_cols = intersect(names(data), names(stata_tmp_using_data_L70))
common_cols_not_by = setdiff(common_cols, c("id"))
if (length(common_cols_not_by) > 0) { stata_tmp_using_data_L70 = dplyr::select(stata_tmp_using_data_L70, -dplyr::all_of(common_cols_not_by)) }
parts_fun_split = stringi::stri_split_fixed(join_type_r_func_L70, "::", n=2)[[1]]
pkg_name_L70 = parts_fun_split[1]
fun_name_L70 = parts_fun_split[2]
merge_fun_obj_L70 = get(fun_name_L70, envir = asNamespace(pkg_name_L70))
data = do.call(merge_fun_obj_L70, list(data, stata_tmp_using_data_L70, by = c("id"), indicator = "stata_merge_indicator_L70"))
 # _merge variable was not generated due to 'nogenerate' option.
data = dplyr::select(data, -dplyr::any_of('stata_merge_indicator_L70'))
rm(stata_tmp_using_data_L70, common_cols, common_cols_not_by, parts_fun_split)
if (exists('master_ids_merge_key')) rm(master_ids_merge_key, using_ids_merge_key)
rm(join_type_r_func_L70, stata_merge_map_left_only_L70, stata_merge_map_right_only_L70, stata_merge_map_both_L70)
rm(pkg_name_L70, fun_name_L70, merge_fun_obj_L70)
# Stata merge type: 1:1, keep(match master), nogenerate 
stata_tmp_using_data_L70 = haven::read_dta(file.path(stata2r_env$working_dir, "extra_data_temp.dta"))

data = sfun_strip_stata_attributes(data)

stata_tmp_using_data_L70 = sfun_strip_stata_attributes(stata_tmp_using_data_L70)

data = dplyr::mutate(data, `id` = as.numeric(`id`))

stata_tmp_using_data_L70 = dplyr::mutate(stata_tmp_using_data_L70, `id` = as.numeric(`id`))

join_type_r_func_L70 = switch('1:1', 
  '1:1' = 'dplyr::full_join', # HACK: Deviates from Stata doc to match test data'
  '1:m' = 'dplyr::left_join',
  'm:1' = 'dplyr::right_join',
  'm:m' = 'dplyr::inner_join'
)

stata_merge_map_left_only_L70 = 1L

stata_merge_map_right_only_L70 = 2L

stata_merge_map_both_L70 = 3L

master_ids_merge_key = dplyr::pull(dplyr::distinct(dplyr::select(data, dplyr::all_of(c("id")))), 1)

using_ids_merge_key = dplyr::pull(dplyr::distinct(dplyr::select(stata_tmp_using_data_L70, dplyr::all_of(c("id")))), 1)

if (any(base::duplicated(dplyr::select(data, dplyr::all_of(c("id")))))) { stop('Merge 1:1 failed: Duplicate keys found in master dataset (data).') }

if (any(base::duplicated(dplyr::select(stata_tmp_using_data_L70, dplyr::all_of(c("id")))))) { stop('Merge 1:1 failed: Duplicate keys found in using dataset (', file.path(stata2r_env$working_dir, "extra_data_temp.dta"), ').') }

if (join_type_r_func_L70 == "dplyr::left_join" && length(base::setdiff(master_ids_merge_key, using_ids_merge_key)) == 0 && length(base::setdiff(using_ids_merge_key, master_ids_merge_key)) > 0) {
  join_type_r_func_L70 = "dplyr::right_join"
  stata_merge_map_left_only_L70 = 1L
  stata_merge_map_right_only_L70 = 1L
  stata_merge_map_both_L70 = 3L
}

common_cols = intersect(names(data), names(stata_tmp_using_data_L70))

common_cols_not_by = setdiff(common_cols, c("id"))

if (length(common_cols_not_by) > 0) { stata_tmp_using_data_L70 = dplyr::select(stata_tmp_using_data_L70, -dplyr::all_of(common_cols_not_by)) }

parts_fun_split = stringi::stri_split_fixed(join_type_r_func_L70, "::", n=2)[[1]]

pkg_name_L70 = parts_fun_split[1]

fun_name_L70 = parts_fun_split[2]

merge_fun_obj_L70 = get(fun_name_L70, envir = asNamespace(pkg_name_L70))

data = do.call(merge_fun_obj_L70, list(data, stata_tmp_using_data_L70, by = c("id"), indicator = "stata_merge_indicator_L70"))

 # _merge variable was not generated due to 'nogenerate' option.

data = dplyr::select(data, -dplyr::any_of('stata_merge_indicator_L70'))

rm(stata_tmp_using_data_L70, common_cols, common_cols_not_by, parts_fun_split)

if (exists('master_ids_merge_key')) rm(master_ids_merge_key, using_ids_merge_key)

rm(join_type_r_func_L70, stata_merge_map_left_only_L70, stata_merge_map_right_only_L70, stata_merge_map_both_L70)

rm(pkg_name_L70, fun_name_L70, merge_fun_obj_L70)

# Stata merge type: 1:1, keep(match master), nogenerate

Error: After Stata line  70 , R data set differs from Stata reference.

Data set from Stata (do_df):
tibble [53 × 18] (S3: tbl_df/tbl/data.frame)
 $ id                   : num [1:53] 1 3 4 5 7 8 9 10 11 14 ...
  ..- attr(*, "label")= chr "id"
  ..- attr(*, "format.stata")= chr "%9.0g"
 $ orig_group_name      : chr [1:53] " Gamma" "Beta" "Beta" " Gamma" ...
  ..- attr(*, "label")= chr "group_orig"
  ..- attr(*, "format.stata")= chr "%6s"
 $ group_clean          : chr [1:53] "gamma" "beta" "beta" "gamma" ...
  ..- attr(*, "format.stata")= chr "%9s"
 $ log_val1             : num [1:53] 4.3 3.97 3.39 3.79 3.73 ...
  ..- attr(*, "format.stata")= chr "%9.0g"
 $ value1               : num [1:53] 77.6 50.1 28.3 42 65.6 ...
  ..- attr(*, "label")= chr "value1"
  ..- attr(*, "format.stata")= chr "%9.0g"
 $ value2               : num [1:53] 4 NA 10 3 3 6 6 8 6 6 ...
  ..- attr(*, "label")= chr "value2"
  ..- attr(*, "format.stata")= chr "%9.0g"
 $ num_val_from_str     : num [1:53] 166 101 136 162 112 141 160 169 137 198 ...
  ..- attr(*, "label")= chr "num_str"
  ..- attr(*, "format.stata")= chr "%10.0g"
 $ value2_squared       : num [1:53] 16 NA 100 9 9 36 36 64 36 36 ...
  ..- attr(*, "format.stata")= chr "%9.0g"
 $ mean_overall_value1  : num [1:53] 66.8 66.8 66.8 66.8 66.8 ...
  ..- attr(*, "format.stata")= chr "%9.0g"
 $ total_value2_by_group: num [1:53] 49 86 86 49 71 71 86 49 86 71 ...
  ..- attr(*, "format.stata")= chr "%9.0g"
 $ obs_date             : Date[1:53], format: "2020-09-21" "2022-02-09" ...
 $ group_code_num       : dbl+lbl [1:53]  3,  2,  2,  3,  1,  1,  2,  3,  2,  1,  4,  1,  2,  2...
   ..@ label       : chr "Numeric code for cleaned group"
   ..@ format.stata: chr "%8.0g"
   ..@ labels      : Named num [1:4] 1 2 3 4
   .. ..- attr(*, "names")= chr [1:4] "alpha" "beta" "gamma" "unknown"
 $ value2_cat_str       : dbl+lbl [1:53]     2, NA(a),     3,     2,     2,     3,     3,     3...
   ..@ label       : chr "RECODE of value2 (value2)"
   ..@ format.stata: chr "%9.0g"
   ..@ labels      : Named num [1:3] 1 2 3
   .. ..- attr(*, "names")= chr [1:3] "Very Low" "Low-Mid" "High"
 $ high_value1_indicator: num [1:53] 1 0 0 0 0 0 0 1 0 1 ...
  ..- attr(*, "format.stata")= chr "%9.0g"
 $ observation_seq_num  : num [1:53] 14 21 34 26 18 33 32 16 23 15 ...
  ..- attr(*, "format.stata")= chr "%9.0g"
 $ total_obs_count      : num [1:53] 36 36 36 36 36 36 36 36 36 36 ...
  ..- attr(*, "format.stata")= chr "%9.0g"
 $ extra_info_val       : num [1:53] NA NA NA NA NA NA NA NA NA NA ...
  ..- attr(*, "label")= chr "extra_info_val"
  ..- attr(*, "format.stata")= chr "%9.0g"
 $ extra_cat_code       : chr [1:53] "" "" "" "" ...
  ..- attr(*, "label")= chr "category_code"
  ..- attr(*, "format.stata")= chr "%2s"
 - attr(*, "label")= chr "Written by R."
NULL

Data set from R (r_df):
tibble [53 × 19] (S3: tbl_df/tbl/data.frame)
 $ id                        : num [1:53] 1 3 4 5 7 8 9 10 11 14 ...
 $ orig_group_name           : chr [1:53] " Gamma" "Beta" "Beta" " Gamma" ...
 $ group_clean               : chr [1:53] "gamma" "beta" "beta" "gamma" ...
 $ log_val1                  : num [1:53] 4.3 3.97 3.39 3.79 3.73 ...
 $ value1                    : num [1:53] 77.6 50.1 28.3 42 65.6 ...
 $ value2                    : num [1:53] 4 NA 10 3 3 6 6 8 6 6 ...
 $ value2_squared            : num [1:53] 16 NA 100 9 9 36 36 64 36 36 ...
 $ obs_date                  : num [1:53] 22179 22685 22420 22164 22113 ...
 $ num_val_from_str          : num [1:53] 166 101 136 162 112 141 160 169 137 198 ...
 $ value2_cat_str            : num [1:53] 2 NA 3 2 2 3 3 3 3 3 ...
 $ mean_overall_value1       : num [1:53] 66.8 66.8 66.8 66.8 66.8 ...
 $ total_value2_by_group     : num [1:53] 49 86 86 49 71 71 86 49 86 71 ...
 $ group_code_num            : num [1:53] 3 2 2 3 1 1 2 3 2 1 ...
 $ high_value1_indicator     : num [1:53] 1 0 0 0 0 0 0 1 0 1 ...
 $ observation_seq_num       : num [1:53] 14 21 34 26 18 33 32 16 23 15 ...
 $ total_obs_count           : num [1:53] 36 36 36 36 36 36 36 36 36 36 ...
 $ stata2r_original_order_idx: num [1:53] 14 21 34 26 18 33 32 16 23 15 ...
 $ extra_info_val            : num [1:53] NA NA NA NA NA NA NA NA NA NA ...
 $ extra_cat_code            : chr [1:53] NA NA NA NA ...
NULL

Differences:List of 2
 $ identical     : logi FALSE
 $ value_mismatch:'data.frame':	15 obs. of  4 variables:
  ..$ row      : int [1:15] 37 38 39 40 41 37 38 39 40 41 ...
  ..$ column   : chr [1:15] "orig_group_name" "orig_group_name" "orig_group_name" "orig_group_name" ...
  ..$ df1_value: chr [1:15] "" "" "" "" ...
  ..$ df2_value: chr [1:15] NA NA NA NA ...
NULL
